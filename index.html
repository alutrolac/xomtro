<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xóm Trọ Vui Vẻ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        :root { --primary: #4f46e5; --accent: #f43f5e; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f1f5f9; color: #1e293b; overflow: hidden; }
        .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .tab-content { display: none; animation: slideUp 0.4s ease-out; height: 100%; }
        .tab-content.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @media print { .no-print { display: none !important; } .print-area { display: block !important; width: 100%; } }
    </style>
</head>
<body>

<div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-indigo-950">
    <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 30px 30px;"></div>
    <div class="glass-panel p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center relative z-10 border border-white/10">
        <div class="w-20 h-20 bg-gradient-to-tr from-indigo-600 to-rose-500 rounded-3xl mx-auto mb-6 flex items-center justify-center shadow-xl">
            <i class="fas fa-shield-alt text-3xl text-white"></i>
        </div>
        <h2 class="text-3xl font-extrabold text-slate-800 mb-2">Smart Inn <span class="text-indigo-600">Deluxe</span></h2>
        <p class="text-slate-500 text-sm mb-8">Hệ thống quản lý nhà trọ chuyên nghiệp</p>
        
        <input type="password" id="login-pass" placeholder="Mật khẩu hệ thống" 
            class="w-full px-6 py-4 rounded-2xl border-none bg-slate-100 focus:ring-2 ring-indigo-500 outline-none mb-4 text-center font-bold text-lg">
        <div class="flex items-center justify-center space-x-2 mb-6 text-slate-600 text-sm">
            <input type="checkbox" id="remember-me" class="w-4 h-4 rounded">
            <label for="remember-me">Duy trì đăng nhập</label>
        </div>
        <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black text-lg shadow-lg hover:bg-indigo-700 transition-all active:scale-95">ĐĂNG NHẬP</button>
        <p id="login-error" class="text-rose-500 mt-4 hidden font-bold">Mật khẩu không chính xác!</p>
    </div>
</div>

<div id="app-interface" class="hidden flex h-screen">
    <aside class="no-print w-24 lg:w-72 bg-white border-r border-slate-200 flex flex-col p-6 transition-all duration-300">
        <div class="hidden lg:block mb-10 px-2 text-2xl font-black italic text-indigo-700 tracking-tighter">XÓM TRỌ VUI VẺ</div>
        <div class="lg:hidden mb-10 mx-auto bg-indigo-100 p-3 rounded-2xl text-indigo-600"><i class="fas fa-hotel text-xl"></i></div>
        
        <nav class="flex-1 space-y-2">
            <button onclick="switchTab('dash')" class="nav-btn w-full flex items-center p-4 rounded-2xl text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 transition font-bold group">
                <i class="fas fa-chart-line w-8 text-xl"></i> <span class="hidden lg:inline ml-2 text-sm uppercase">Tổng quan</span>
            </button>
            <button onclick="switchTab('rooms')" class="nav-btn w-full flex items-center p-4 rounded-2xl text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 transition font-bold">
                <i class="fas fa-bed w-8 text-xl"></i> <span class="hidden lg:inline ml-2 text-sm uppercase">Phòng & Khách</span>
            </button>
            <button onclick="switchTab('billing')" class="nav-btn w-full flex items-center p-4 rounded-2xl text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 transition font-bold">
                <i class="fas fa-file-invoice-dollar w-8 text-xl"></i> <span class="hidden lg:inline ml-2 text-sm uppercase">Lập hóa đơn</span>
            </button>
            <button onclick="switchTab('history')" class="nav-btn w-full flex items-center p-4 rounded-2xl text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 transition font-bold">
                <i class="fas fa-history w-8 text-xl"></i> <span class="hidden lg:inline ml-2 text-sm uppercase">Lịch sử thu</span>
            </button>
            <button onclick="switchTab('settings')" class="nav-btn w-full flex items-center p-4 rounded-2xl text-slate-500 hover:bg-indigo-50 hover:text-indigo-600 transition font-bold">
                <i class="fas fa-sliders-h w-8 text-xl"></i> <span class="hidden lg:inline ml-2 text-sm uppercase">Cài đặt giá</span>
            </button>
        </nav>

        <button onclick="logout()" class="w-full flex items-center p-4 rounded-2xl text-rose-500 hover:bg-rose-50 font-bold transition">
            <i class="fas fa-sign-out-alt w-8 text-xl"></i> <span class="hidden lg:inline ml-2 text-sm uppercase">Đăng xuất</span>
        </button>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
        <header class="no-print h-20 bg-white/50 backdrop-blur-md px-8 flex items-center justify-between border-b border-slate-200">
            <h2 id="header-title" class="text-xl font-black text-slate-800 uppercase tracking-wide">Bảng điều khiển</h2>
            <div class="flex items-center space-x-4">
                <div class="text-right hidden sm:block">
                    <p id="clock" class="text-sm font-bold text-slate-700"></p>
                    <p class="text-[10px] text-indigo-500 font-black uppercase">Phiên bản Deluxe v1.0</p>
                </div>
                <button onclick="exportData()" class="bg-white border p-3 rounded-xl hover:bg-slate-50 text-indigo-600 shadow-sm"><i class="fas fa-cloud-download-alt"></i></button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 md:p-10 no-scrollbar">
            
            <section id="tab-dash" class="tab-content active space-y-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                        <div class="w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center text-blue-600 mb-4"><i class="fas fa-door-open"></i></div>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Tổng số phòng</p>
                        <h4 class="text-3xl font-black mt-1" id="st-total">0</h4>
                    </div>
                    <div class="bg-indigo-600 p-6 rounded-[2rem] shadow-xl shadow-indigo-100 text-white">
                        <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center text-white mb-4"><i class="fas fa-user-check"></i></div>
                        <p class="text-indigo-100 text-xs font-bold uppercase tracking-widest">Đang ở</p>
                        <h4 class="text-3xl font-black mt-1" id="st-occupied">0</h4>
                    </div>
                    <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                        <div class="w-12 h-12 bg-rose-100 rounded-2xl flex items-center justify-center text-rose-600 mb-4"><i class="fas fa-key"></i></div>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Phòng trống</p>
                        <h4 class="text-3xl font-black mt-1 text-rose-600" id="st-empty">0</h4>
                    </div>
                    <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                        <div class="w-12 h-12 bg-emerald-100 rounded-2xl flex items-center justify-center text-emerald-600 mb-4"><i class="fas fa-wallet"></i></div>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Doanh thu dự kiến</p>
                        <h4 class="text-3xl font-black mt-1 text-emerald-600" id="st-revenue">0đ</h4>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h3 class="font-black text-lg mb-6 flex items-center"><i class="fas fa-chart-pie mr-2 text-indigo-500"></i> HIỆU SUẤT CHO THUÊ</h3>
                        <div class="h-[300px]"><canvas id="chart-pie"></canvas></div>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 overflow-hidden relative">
                        <h3 class="font-black text-lg mb-6 italic text-indigo-600">THÔNG BÁO</h3>
                        <div id="alerts-list" class="space-y-4">
                            </div>
                    </div>
                </div>
            </section>

            <section id="tab-rooms" class="tab-content space-y-6">
                <div class="flex items-center justify-between">
                    <div class="flex bg-white p-1 rounded-2xl shadow-sm border">
                        <button onclick="renderRoomGrid('all')" class="px-6 py-2 rounded-xl text-xs font-bold hover:bg-indigo-50 transition uppercase">Tất cả</button>
                        <button onclick="renderRoomGrid('Available')" class="px-6 py-2 rounded-xl text-xs font-bold text-rose-500 hover:bg-rose-50 transition uppercase">Trống</button>
                    </div>
                    <button onclick="toggleModal('modal-room', true)" class="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-black shadow-lg shadow-indigo-100 hover:scale-105 transition active:scale-95">
                        + THÊM PHÒNG
                    </button>
                </div>
                <div id="room-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8"></div>
            </section>

            <section id="tab-billing" class="tab-content max-w-5xl mx-auto space-y-8">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="lg:col-span-2 bg-white p-8 rounded-[2.5rem] shadow-sm border space-y-6 h-fit">
                        <h3 class="text-xl font-black border-b pb-4 tracking-tighter uppercase">Nhập chỉ số tháng này</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Chọn phòng cần tính</label>
                                <select id="bill-room-select" onchange="loadRoomIndices()" class="w-full p-4 mt-1 bg-slate-50 border-none rounded-2xl outline-none ring-2 ring-transparent focus:ring-indigo-500 transition"></select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-slate-50 p-4 rounded-2xl">
                                    <label class="text-[10px] font-black uppercase text-slate-400">Số Điện mới</label>
                                    <input type="number" id="b-e-new" class="w-full bg-transparent border-none outline-none font-bold text-lg p-0" placeholder="0">
                                    <p class="text-[9px] text-indigo-500 mt-1">Cũ: <span id="b-e-old">0</span></p>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-2xl">
                                    <label class="text-[10px] font-black uppercase text-slate-400">Số Nước mới</label>
                                    <input type="number" id="b-w-new" class="w-full bg-transparent border-none outline-none font-bold text-lg p-0" placeholder="0">
                                    <p class="text-[9px] text-indigo-500 mt-1">Cũ: <span id="b-w-old">0</span></p>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl">
                                <label class="text-[10px] font-black uppercase text-slate-400">Phí khác (Rác, Net...)</label>
                                <input type="number" id="b-others" class="w-full bg-transparent border-none outline-none font-bold text-lg p-0" value="0">
                            </div>
                            <button onclick="generateBill()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black text-xl shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition">XUẤT PHIẾU THU</button>
                        </div>
                    </div>

                    <div id="invoice-view" class="lg:col-span-3 hidden">
                        <div id="invoice-capture" class="bg-[#fefce8] p-10 border-2 border-dashed border-slate-300 rounded-sm relative print-area shadow-2xl">
                            <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-file-invoice-dollar text-7xl"></i></div>
                            <h2 class="text-center font-black text-2xl uppercase tracking-[0.2em] mb-1">Phiếu Thanh Toán</h2>
                            <p id="inv-date" class="text-center text-[10px] font-bold text-slate-400 mb-8"></p>
                            
                            <div class="flex justify-between font-black text-lg mb-8 bg-white/50 p-4 rounded-xl border border-white">
                                <span>PHÒNG: <span id="inv-room">--</span></span>
                                <span>KHÁCH: <span id="inv-tenant">--</span></span>
                            </div>

                            <div class="space-y-4 mb-10 font-medium" id="inv-details"></div>

                            <div class="flex justify-between items-end border-t-2 border-slate-800 pt-8">
                                <div class="text-center">
                                    <p class="text-[9px] font-black uppercase mb-2">Quét QR thanh toán</p>
                                    <img id="inv-qr" src="" class="w-32 h-32 bg-white p-1 border shadow-sm">
                                </div>
                                <div class="text-right">
                                    <p class="text-xs font-black text-slate-400 uppercase tracking-widest">TỔNG TIỀN PHẢI TRẢ</p>
                                    <p id="inv-total" class="text-4xl font-black text-indigo-700 font-mono"></p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 flex gap-4 no-print">
                            <button onclick="window.print()" class="flex-1 bg-white p-4 rounded-2xl font-black border hover:bg-slate-50 transition shadow-sm">IN HÓA ĐƠN (PDF)</button>
                            <button onclick="copyBillText()" class="flex-1 bg-indigo-50 text-indigo-600 p-4 rounded-2xl font-black hover:bg-indigo-100 transition shadow-sm">COPY TIN NHẮN</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="tab-history" class="tab-content">
                <div class="bg-white rounded-[2.5rem] shadow-sm border overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b">
                            <tr>
                                <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest">Thời gian</th>
                                <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest">Phòng</th>
                                <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest">Số tiền</th>
                                <th class="p-6 text-[10px] font-black uppercase text-slate-400 tracking-widest text-right">Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody id="history-table" class="divide-y divide-slate-100 font-medium"></tbody>
                    </table>
                </div>
            </section>

            <section id="tab-settings" class="tab-content max-w-2xl mx-auto bg-white p-10 rounded-[2.5rem] shadow-sm border space-y-8">
                <h3 class="text-2xl font-black tracking-tighter border-b pb-4">CẤU HÌNH HỆ THỐNG</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Đơn giá điện (1kWh)</label>
                        <input type="number" id="cfg-e" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-2 ring-transparent focus:ring-indigo-500 font-bold">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Đơn giá nước (1m3)</label>
                        <input type="number" id="cfg-w" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-2 ring-transparent focus:ring-indigo-500 font-bold">
                    </div>
                    <div class="md:col-span-2 py-4 border-t mt-4">
                        <h4 class="font-black text-indigo-600 mb-4">THÔNG TIN CHUYỂN KHOẢN</h4>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Ngân hàng (Ví dụ: MBBank)</label>
                        <input type="text" id="cfg-bank" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-2 ring-transparent focus:ring-indigo-500 font-bold">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Số tài khoản</label>
                        <input type="text" id="cfg-stk" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-2 ring-transparent focus:ring-indigo-500 font-bold">
                    </div>
                    <div class="md:col-span-2 space-y-2">
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Tên chủ tài khoản (KHÔNG DẤU)</label>
                        <input type="text" id="cfg-owner" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-2 ring-transparent focus:ring-indigo-500 font-bold">
                    </div>
                </div>
                <button onclick="saveConfig()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-xl hover:bg-indigo-600 transition shadow-xl">CẬP NHẬT CẤU HÌNH</button>
            </section>

        </div>
    </main>
</div>

<div id="modal-room" class="fixed inset-0 z-[110] bg-slate-900/60 hidden backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-[2.5rem] w-full max-w-lg shadow-2xl overflow-hidden animate-slideUp">
        <div class="p-8 border-b flex justify-between items-center bg-indigo-50/50">
            <h3 class="text-2xl font-black tracking-tighter">CÀI ĐẶT PHÒNG MỚI</h3>
            <button onclick="toggleModal('modal-room', false)" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times-circle text-2xl"></i></button>
        </div>
        <div class="p-8 space-y-5">
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="mr-name" placeholder="Tên phòng (101)" class="w-full p-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 ring-indigo-500 font-bold">
                <input type="number" id="mr-price" placeholder="Giá thuê mặc định" class="w-full p-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 ring-indigo-500 font-bold">
            </div>
            <input type="text" id="mr-tenant" placeholder="Họ tên khách thuê (Bỏ trống nếu chưa có)" class="w-full p-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 ring-indigo-500 font-bold">
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-slate-400 uppercase ml-2">Số điện khởi đầu</label>
                    <input type="number" id="mr-e" value="0" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold border border-slate-200">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-slate-400 uppercase ml-2">Số nước khởi đầu</label>
                    <input type="number" id="mr-w" value="0" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold border border-slate-200">
                </div>
            </div>
            <button onclick="addRoom()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black text-lg shadow-xl shadow-indigo-100 mt-4">HOÀN TẤT THIẾT LẬP</button>
        </div>
    </div>
</div>

<script>
    // --- DATABASE & STATE ---
    let db = JSON.parse(localStorage.getItem('SMART_INN_DELUXE_V1')) || {
        rooms: [],
        history: [],
        config: { ePrice: 3500, wPrice: 15000, bank: "MB", stk: "0912345678", owner: "NGUYEN VAN A" },
        auth: "admin123"
    };

    let chartPie = null;

    // --- INITIALIZATION ---
    window.onload = () => {
        if(localStorage.getItem('SMART_INN_AUTH') === 'true' || sessionStorage.getItem('SMART_INN_AUTH') === 'true') {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-interface').classList.remove('hidden');
            refreshApp();
        }
        updateTime();
        setInterval(updateTime, 1000);
    };

    function updateTime() {
        document.getElementById('clock').innerText = new Date().toLocaleString('vi-VN');
    }

    // --- AUTHENTICATION ---
    function handleLogin() {
        const pass = document.getElementById('login-pass').value;
        const remember = document.getElementById('remember-me').checked;
        if(pass === db.auth) {
            if(remember) localStorage.setItem('SMART_INN_AUTH', 'true');
            else sessionStorage.setItem('SMART_INN_AUTH', 'true');
            location.reload();
        } else {
            document.getElementById('login-error').classList.remove('hidden');
        }
    }

    function logout() {
        localStorage.removeItem('SMART_INN_AUTH');
        sessionStorage.removeItem('SMART_INN_AUTH');
        location.reload();
    }

    // --- NAVIGATION ---
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        document.getElementById('header-title').innerText = document.querySelector(`button[onclick*="${tabId}"]`).innerText;
        refreshApp();
    }

    function toggleModal(id, show) {
        document.getElementById(id).classList.toggle('hidden', !show);
    }

    // --- ROOM MANAGEMENT ---
    function addRoom() {
        const name = document.getElementById('mr-name').value;
        const price = Number(document.getElementById('mr-price').value);
        const tenant = document.getElementById('mr-tenant').value;
        
        if(!name || !price) return alert("Cần nhập tên và giá phòng!");

        db.rooms.push({
            id: Date.now(),
            name, price, tenant,
            eOld: Number(document.getElementById('mr-e').value || 0),
            wOld: Number(document.getElementById('mr-w').value || 0),
            status: tenant ? 'Occupied' : 'Available'
        });
        saveDB();
        toggleModal('modal-room', false);
        refreshApp();
    }

    function deleteRoom(id) {
        if(confirm("Xóa phòng này? Mọi dữ liệu chỉ số sẽ mất!")) {
            db.rooms = db.rooms.filter(r => r.id !== id);
            saveDB();
            refreshApp();
        }
    }

    function renderRoomGrid(filter = 'all') {
        const container = document.getElementById('room-grid');
        let list = db.rooms;
        if(filter !== 'all') list = db.rooms.filter(r => r.status === filter);

        container.innerHTML = list.map(r => `
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border-2 ${r.status === 'Occupied' ? 'border-transparent shadow-indigo-50' : 'border-dashed border-slate-200'} relative hover:shadow-xl transition-all group">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h4 class="text-3xl font-black text-slate-800 tracking-tighter">${r.name}</h4>
                        <p class="text-xs font-bold text-slate-400 mt-1 uppercase"><i class="fas fa-user mr-1 text-indigo-500"></i> ${r.tenant || 'Cần tìm khách'}</p>
                    </div>
                    <span class="px-4 py-1.5 rounded-full text-[10px] font-black tracking-widest ${r.status === 'Occupied' ? 'bg-indigo-100 text-indigo-600' : 'bg-rose-100 text-rose-600'}">
                        ${r.status === 'Occupied' ? 'ĐÃ THUÊ' : 'PHÒNG TRỐNG'}
                    </span>
                </div>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-slate-50 p-4 rounded-3xl">
                        <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Tiền phòng</p>
                        <p class="font-black text-slate-800">${r.price.toLocaleString()}đ</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-3xl">
                        <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Chỉ số Điện</p>
                        <p class="font-black text-indigo-600">${r.eOld} <span class="text-[10px] text-slate-400">kWh</span></p>
                    </div>
                </div>
                <div class="mt-6 flex gap-2">
                    <button onclick="deleteRoom(${r.id})" class="flex-1 bg-rose-50 text-rose-500 p-4 rounded-2xl hover:bg-rose-500 hover:text-white transition"><i class="fas fa-trash-alt"></i></button>
                    <button class="flex-[3] bg-slate-900 text-white p-4 rounded-2xl font-black text-sm uppercase tracking-widest">Chi tiết</button>
                </div>
            </div>
        `).join('');
    }

    // --- BILLING LOGIC ---
    function loadRoomIndices() {
        const rid = document.getElementById('bill-room-select').value;
        const room = db.rooms.find(r => r.id == rid);
        if(room) {
            document.getElementById('b-e-old').innerText = room.eOld;
            document.getElementById('b-w-old').innerText = room.wOld;
        }
    }

    function generateBill() {
        const rid = document.getElementById('bill-room-select').value;
        const room = db.rooms.find(r => r.id == rid);
        const eNew = Number(document.getElementById('b-e-new').value);
        const wNew = Number(document.getElementById('b-w-new').value);
        const others = Number(document.getElementById('b-others').value || 0);

        if(!eNew || !wNew || eNew < room.eOld || wNew < room.wOld) return alert("Lỗi chỉ số mới!");

        const eUsed = eNew - room.eOld;
        const wUsed = wNew - room.wOld;
        const eMoney = eUsed * db.config.ePrice;
        const wMoney = wUsed * db.config.wPrice;
        const grandTotal = room.price + eMoney + wMoney + others;

        // UI Update
        document.getElementById('inv-room').innerText = room.name;
        document.getElementById('inv-tenant').innerText = room.tenant;
        document.getElementById('inv-date').innerText = new Date().toLocaleString();
        document.getElementById('inv-total').innerText = grandTotal.toLocaleString() + "đ";
        document.getElementById('inv-details').innerHTML = `
            <div class="flex justify-between border-b border-slate-100 pb-2"><span>1. Tiền thuê phòng:</span> <b class="text-slate-800">${room.price.toLocaleString()}đ</b></div>
            <div class="flex justify-between border-b border-slate-100 pb-2">
                <span>2. Tiền điện (${eNew} - ${room.eOld}): <b class="text-indigo-600">${eUsed} số</b></span>
                <b class="text-slate-800">${eMoney.toLocaleString()}đ</b>
            </div>
            <div class="flex justify-between border-b border-slate-100 pb-2">
                <span>3. Tiền nước (${wNew} - ${room.wOld}): <b class="text-blue-500">${wUsed} m3</b></span>
                <b class="text-slate-800">${wMoney.toLocaleString()}đ</b>
            </div>
            ${others > 0 ? `<div class="flex justify-between border-b border-slate-100 pb-2"><span>4. Phí dịch vụ khác:</span> <b class="text-slate-800">${others.toLocaleString()}đ</b></div>` : ''}
        `;

        const qrUrl = `https://img.vietqr.io/image/${db.config.bank}-${db.config.stk}-compact2.png?amount=${grandTotal}&addInfo=Tien%20Phong%20${room.name}&accountName=${encodeURIComponent(db.config.owner)}`;
        document.getElementById('inv-qr').src = qrUrl;
        document.getElementById('invoice-view').classList.remove('hidden');

        // Store History & Update room
        db.history.unshift({ time: new Date().toLocaleString(), room: room.name, amount: grandTotal });
        room.eOld = eNew;
        room.wOld = wNew;
        saveDB();
    }

    // --- REFRESH APP ---
    function refreshApp() {
        const total = db.rooms.length;
        const occupied = db.rooms.filter(r => r.status === 'Occupied').length;
        const revenue = db.rooms.filter(r => r.status === 'Occupied').reduce((sum, r) => sum + r.price, 0);

        document.getElementById('st-total').innerText = total;
        document.getElementById('st-occupied').innerText = occupied;
        document.getElementById('st-empty').innerText = total - occupied;
        document.getElementById('st-revenue').innerText = revenue.toLocaleString() + "đ";

        // Chart
        initPie(occupied, total - occupied);
        
        // Billing Select
        const sel = document.getElementById('bill-room-select');
        const occRooms = db.rooms.filter(r => r.status === 'Occupied');
        sel.innerHTML = occRooms.map(r => `<option value="${r.id}">${r.name} (${r.tenant})</option>`).join('');
        if(occRooms.length > 0) loadRoomIndices();

        // History
        document.getElementById('history-table').innerHTML = db.history.map(h => `
            <tr>
                <td class="p-6 text-slate-500 text-xs">${h.time}</td>
                <td class="p-6 font-black">${h.room}</td>
                <td class="p-6 font-black text-indigo-600">${h.amount.toLocaleString()}đ</td>
                <td class="p-6 text-right"><span class="bg-emerald-100 text-emerald-600 px-3 py-1 rounded-full text-[10px] font-bold">THÀNH CÔNG</span></td>
            </tr>
        `).join('');

        // Settings
        document.getElementById('cfg-e').value = db.config.ePrice;
        document.getElementById('cfg-w').value = db.config.wPrice;
        document.getElementById('cfg-bank').value = db.config.bank;
        document.getElementById('cfg-stk').value = db.config.stk;
        document.getElementById('cfg-owner').value = db.config.owner;

        renderRoomGrid();
    }

    function initPie(occ, empty) {
        const ctx = document.getElementById('chart-pie').getContext('2d');
        if(chartPie) chartPie.destroy();
        chartPie = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Đã thuê', 'Phòng trống'],
                datasets: [{
                    data: [occ, empty],
                    backgroundColor: ['#4f46e5', '#f43f5e'],
                    borderWidth: 0,
                    borderRadius: 10
                }]
            },
            options: { cutout: '80%', plugins: { legend: { position: 'bottom', labels: { font: { weight: 'bold' } } } } }
        });
    }

    function saveConfig() {
        db.config = {
            ePrice: Number(document.getElementById('cfg-e').value),
            wPrice: Number(document.getElementById('cfg-w').value),
            bank: document.getElementById('cfg-bank').value,
            stk: document.getElementById('cfg-stk').value,
            owner: document.getElementById('cfg-owner').value
        };
        saveDB();
        alert("Cài đặt đã cập nhật!");
    }

    function saveDB() { localStorage.setItem('SMART_INN_DELUXE_V1', JSON.stringify(db)); }
    
    function exportData() {
        const blob = new Blob([JSON.stringify(db)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Data_Inn_Deluxe_${new Date().getTime()}.json`;
        a.click();
    }
</script>
</body>
</html>
